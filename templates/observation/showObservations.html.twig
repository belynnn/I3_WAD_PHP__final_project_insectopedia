{% extends 'base.html.twig' %}

{% block title %}Observations{% endblock %}

{% block body %}
    <style>
        #map {
            width: 100%;
            height: 540px;
        }
        .hidden {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
    </script>

    <h2 class="bg-gradient-green mb-3 px-4 pb-2 pt-2 text-white">Observations</h2>

    <div class="mb-3">
        <button type="button" class="btn btn-success" id="mapToggle">Carte</button>
        <button type="button" class="btn btn-success" id="gridToggle">Grille</button>
        <button type="button" class="btn btn-success" id="listToggle">Liste</button>
    </div>

    {# MAP #}
    <div class="mt-2" id="mapContainer">
        <div id="map"></div>
    </div>

    {# GRILLE  #}
    <div id="gridContainer" class="hidden">
        <div class="container text-center">
            <div class="row row-cols-3">
                {% for observation in observations %}
                    <div class="col">
                        <a href="{{ path('app_observation', {id: observation.id}) }}">{{ observation.nameInsect }}</a>
                        {% if observation.photo is not null and observation.photo != 'null' %}
                            <div><img src="../uploads/photos/{{ observation.photo }}" width="250px" height="200px" /></div>
                        {% else %}
                            <div><img src="https://answers-afd.microsoft.com/static/images/image-not-found.jpg" width="250px" /></div>
                        {% endif %}
                    </div>
                {% else %}
                    Aucune observation trouvée.
                {% endfor %}
            </div>
        </div>
    </div>

    {# LISTE #}
    <div id="listContainer" class="hidden">
        <div class="container">
            {% if observations is not empty %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Nom de l'insecte</th>
                            <th>Longitude</th>
                            <th>Latitude</th>
                            <th>Pseudo</th>
                            <th>Date d'observation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for observation in observations %}
                            <tr>
                                <td>
                                    {% if observation.photo is not null and observation.photo != 'null' %}
                                        <img src="../uploads/photos/{{ observation.photo }}" width="64px" height="64px" />
                                    {% else %}
                                        <img src="https://answers-afd.microsoft.com/static/images/image-not-found.jpg" width="64px" height="64px" />
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ path('app_observation', {id: observation.id}) }}">{{ observation.nameInsect }}</a>
                                </td>
                                <td>{{ observation.longitude }}</td>
                                <td>{{ observation.latitude }}</td>
                                <td>{{ observation.createdBy.pseudo }}</td>
                                <td>{{ observation.dateObservation|date('d/m/Y') }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Aucune observation trouvée.</p>
            {% endif %}
        </div>
    </div>

    <script>
        var myIcon = L.icon({
            iconUrl: 'https://cdn.discordapp.com/attachments/201377710419738625/1295682438475022387/icon_map.png?ex=67122ccd&is=6710db4d&hm=8cc27e91047937466bcfb3de15d63f276e17fb62cbe6c34db8b0764af2ef97fe&',
            iconSize: [32, 32],
            popupAnchor: [-3, -76],
        });
        var map = L.map('map').setView([50.499527, 4.475403], 8);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Ajout des marqueurs dynamiquement
        {% for observation in observations %}
            {% if observation.latitude is not null and observation.longitude is not null %}
                var marker = L.marker([{{ observation.latitude }}, {{ observation.longitude }}], {icon: myIcon}).addTo(map);
                marker.bindTooltip("{{ observation.nameInsect }}<br>{{ observation.dateObservation|date('d/m/Y') }}");
                
                // Ajouter l'événement click pour rediriger vers la page de l'observation
                marker.on('click', function() {
                    window.location.href = "{{ path('app_observation', {id: observation.id}) }}";
                });
            {% endif %}
        {% endfor %}

        // Gestion de l'affichage carte/liste
        document.addEventListener('DOMContentLoaded', function () {
            const mapContainer = document.getElementById('mapContainer');
            const gridContainer = document.getElementById('gridContainer');
            const listContainer = document.getElementById('listContainer');
            const mapToggle = document.getElementById('mapToggle');
            const gridToggle = document.getElementById('gridToggle');
            const listToggle = document.getElementById('listToggle');

            // Afficher la carte par défaut
            mapContainer.classList.remove('hidden');
            listContainer.classList.add('hidden');
            gridContainer.classList.add('hidden');
            map.invalidateSize(); // Redimensionne la carte Leaflet

            mapToggle.addEventListener('click', () => {
                mapContainer.classList.remove('hidden');
                listContainer.classList.add('hidden');
                gridContainer.classList.add('hidden');
                map.invalidateSize(); // Redimensionne la carte Leaflet lorsqu'elle est affichée
            });

            listToggle.addEventListener('click', () => {
                mapContainer.classList.add('hidden');
                listContainer.classList.remove('hidden');
                gridContainer.classList.add('hidden');
            });

            gridToggle.addEventListener('click', () => {
                mapContainer.classList.add('hidden');
                listContainer.classList.add('hidden');
                gridContainer.classList.remove('hidden');
            });
        });
    </script>
{% endblock %}